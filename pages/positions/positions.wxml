<!--pages/positions/positions.wxml-->
<view class="container">
  <!-- å®æ—¶çŠ¶æ€å¤´éƒ¨ -->
  <view class="realtime-header">
    <view class="realtime-left">
      <view class="realtime-title">æˆ‘çš„æŒä»“</view>
      <view class="realtime-time" wx:if="{{lastUpdateTime}}">{{lastUpdateTime}}æ›´æ–°</view>
    </view>
    <view class="realtime-actions">
      <view class="status-indicator {{apiStatus}}" bindtap="showApiStatus">
        <view class="status-dot"></view>
        <text wx:if="{{apiStatus === 'success'}}">å®æ—¶</text>
        <text wx:elif="{{apiStatus === 'error'}}">ç¦»çº¿</text>
        <text wx:else>è¿æ¥ä¸­</text>
      </view>
      <view class="refresh-btn {{refreshing ? 'spinning' : ''}}" bindtap="refreshData">
        ğŸ”„
      </view>
      <view class="more-btn" bindtap="onMoreActions">â‹¯</view>
    </view>
  </view>

  <!-- èµ„äº§æ¦‚è§ˆå¡ç‰‡ -->
  <view class="position-summary {{totalUnrealizedPL >= 0 ? '' : 'loss'}}">
    <view class="position-total">
      <view class="position-total-label">æ€»å¸‚å€¼</view>
      <view class="position-total-value">Â¥{{totalMarketValue}}</view>
      <view class="position-total-change">
        {{totalUnrealizedPL >= 0 ? '+' : ''}}Â¥{{totalUnrealizedPL}} ({{returnRate}}%)
      </view>
    </view>
    
    <view class="position-details">
      <view class="position-detail-item">
        <view class="position-detail-label">æŒä»“æ•°</view>
        <view class="position-detail-value">{{positions.length}}</view>
      </view>
      <view class="position-detail-item">
        <view class="position-detail-label">æ€»æˆæœ¬</view>
        <view class="position-detail-value">Â¥{{totalCost}}</view>
      </view>
      <view class="position-detail-item">
        <view class="position-detail-label">ç›ˆäºç‡</view>
        <view class="position-detail-value">{{returnRate}}%</view>
      </view>
    </view>
  </view>

  <!-- æŒä»“åˆ—è¡¨ -->
  <view wx:if="{{loading}}" class="loading-container">
    <view class="loading-spinner"></view>
    <view class="loading-text">åŠ è½½ä¸­...</view>
  </view>

  <view wx:elif="{{positions.length === 0}}" class="empty-state">
    <view class="empty-icon">ğŸ“Š</view>
    <view class="empty-text">æš‚æ— æŒä»“æ•°æ®</view>
    <view class="btn btn-primary" bindtap="onAddTransaction" style="margin-top: 30rpx;">
      æ·»åŠ äº¤æ˜“è®°å½•
    </view>
  </view>

  <view wx:else class="card">
    <view class="card-header flex-between">
      <text>æŒä»“æ˜ç»† ({{positions.length}})</text>
      <view class="auto-refresh-toggle {{autoRefresh ? 'active' : ''}}" bindtap="toggleAutoRefresh">
        <view class="toggle-dot"></view>
        <text>è‡ªåŠ¨åˆ·æ–°</text>
      </view>
    </view>
    
    <view class="card-body">
      <view class="stock-list">
        <view 
          class="stock-card" 
          wx:for="{{positions}}" 
          wx:key="{{item.stockCode}}"
          bindtap="onPositionTap"
          data-position="{{item}}"
        >
          <view class="stock-header">
            <view class="stock-left">
              <view class="stock-code">{{item.stockCode}}</view>
              <view class="stock-name">{{item.stockName}}</view>
              <view class="stock-holder">{{item.userName}}</view>
            </view>
            <view class="stock-right">
              <view class="stock-price">
                {{item.currentPrice ? 'Â¥' + item.currentPrice : 'æš‚æ— æŠ¥ä»·'}}
              </view>
              <view class="stock-change {{item.unrealizedPL >= 0 ? 'positive' : 'negative'}}" wx:if="{{item.currentPrice}}">
                {{item.unrealizedPL >= 0 ? '+' : ''}}{{item.unrealizedPLPercent}}%
              </view>
              <view class="data-source" wx:if="{{item.stockData}}">
                {{item.stockData.source === 'mock' ? 'æ¨¡æ‹Ÿ' : 'å®æ—¶'}}
              </view>
            </view>
          </view>
          
          <view class="stock-info">
            <view class="stock-info-item">
              <view class="stock-info-label">æŒä»“</view>
              <view class="stock-info-value">{{item.totalQuantity}}è‚¡</view>
            </view>
            <view class="stock-info-item">
              <view class="stock-info-label">æˆæœ¬</view>
              <view class="stock-info-value">Â¥{{item.averagePrice}}</view>
            </view>
            <view class="stock-info-item">
              <view class="stock-info-label">å¸‚å€¼</view>
              <view class="stock-info-value">Â¥{{item.totalMarketValue || item.totalCost}}</view>
            </view>
            <view class="stock-info-item">
              <view class="stock-info-label">ç›ˆäº</view>
              <view class="stock-info-value {{item.unrealizedPL >= 0 ? 'text-green' : 'text-red'}}">
                {{item.unrealizedPL >= 0 ? '+' : ''}}Â¥{{item.unrealizedPL || '0'}}
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- å¿«é€Ÿæ“ä½œ -->
  <view class="card" wx:if="{{positions.length > 0}}">
    <view class="card-header">å¿«é€Ÿæ“ä½œ</view>
    <view class="card-body">
      <view class="grid grid-2">
        <view class="action-item" bindtap="onAddTransaction">
          <view class="action-icon">ğŸ“</view>
          <view class="action-text">æ·»åŠ äº¤æ˜“</view>
        </view>
        <view class="action-item" bindtap="onExportData">
          <view class="action-icon">ğŸ“Š</view>
          <view class="action-text">å¯¼å‡ºæ•°æ®</view>
        </view>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨é—´è· -->
  <view style="height: 100rpx;"></view>
</view>
