<!--pages/import-data/import-data.wxml-->
<view class="container">
  <view class="card">
    <view class="card-header">å¯¼å…¥äº¤æ˜“è®°å½•</view>
    <view class="card-body">
      
      <!-- ç”¨æˆ·é€‰æ‹© -->
      <view class="form-item">
        <view class="label">
          <text class="required">*</text>
          é€‰æ‹©ç”¨æˆ·
        </view>
        <picker bindchange="onUserChange" value="{{selectedUserIndex}}" range="{{users}}" range-key="name">
          <view class="picker">{{selectedUserName}}</view>
        </picker>
      </view>

      <!-- åˆ¸å•†é€‰æ‹© -->
      <view class="form-item">
        <view class="label">åˆ¸å•†æ¨¡æ¿</view>
        <picker bindchange="onBrokerChange" value="{{selectedBrokerIndex}}" range="{{brokers}}" range-key="name">
          <view class="picker">{{selectedBrokerName}}</view>
        </picker>
      </view>

      <!-- æ–‡ä»¶é€‰æ‹© -->
      <view class="form-item">
        <view class="label">
          <text class="required">*</text>
          é€‰æ‹©æ–‡ä»¶
        </view>
        <view class="file-upload" bindtap="chooseFile">
          <view class="upload-area">
            <text class="upload-icon">ğŸ“</text>
            <text class="upload-text">
              {{fileName || 'ç‚¹å‡»é€‰æ‹©CSVæ–‡ä»¶'}}
            </text>
          </view>
        </view>
        <view class="file-tips">
          æ”¯æŒCSVã€Excelæ–‡ä»¶ï¼Œå»ºè®®å…ˆä¸‹è½½æ¨¡æ¿
        </view>
      </view>

      <!-- æ“ä½œæŒ‰é’® -->
      <view class="action-buttons">
        <button 
          class="btn btn-secondary" 
          bindtap="downloadTemplate"
          loading="{{isProcessing}}"
        >
          ä¸‹è½½æ¨¡æ¿
        </button>
        
        <button 
          class="btn btn-primary" 
          bindtap="previewImport"
          disabled="{{!fileContent || !selectedUserId || isProcessing}}"
          loading="{{isProcessing}}"
        >
          é¢„è§ˆæ•°æ®
        </button>
      </view>
    </view>
  </view>

  <!-- é¢„è§ˆç»“æœ -->
  <view wx:if="{{showPreview}}" class="card">
    <view class="card-header">
      æ•°æ®é¢„è§ˆ
      <text class="summary">({{summaryValid}}/{{summaryTotal}}æ¡æœ‰æ•ˆ)</text>
    </view>
    
    <view class="card-body">
      <!-- å¯¼å…¥æ‘˜è¦ -->
      <view class="import-summary">
        <view class="summary-item">
          <text class="label">æ£€æµ‹åˆ¸å•†ï¼š</text>
          <text class="value">{{previewData.summary.broker}}</text>
        </view>
        <view class="summary-item">
          <text class="label">åŒ¹é…åº¦ï¼š</text>
          <text class="value">{{confidencePercent}}%</text>
        </view>
        <view class="summary-item">
          <text class="label">æœ‰æ•ˆè®°å½•ï¼š</text>
          <text class="value valid">{{summaryValid}}æ¡</text>
        </view>
        <view class="summary-item">
          <text class="label">æ— æ•ˆè®°å½•ï¼š</text>
          <text class="value invalid">{{summaryInvalid}}æ¡</text>
        </view>
      </view>

      <!-- é¢„è§ˆè¡¨æ ¼ -->
      <view class="preview-table" wx:if="{{previewData.transactions.length > 0}}">
        <view class="table-header">
          <view class="col-date">æ—¥æœŸ</view>
          <view class="col-code">ä»£ç </view>
          <view class="col-name">åç§°</view>
          <view class="col-type">ç±»å‹</view>
          <view class="col-price">ä»·æ ¼</view>
          <view class="col-qty">æ•°é‡</view>
        </view>
        
        <scroll-view class="table-body" scroll-y>
          <view class="table-row" wx:for="{{previewData.transactions}}" wx:key="id">
            <view class="col-date">{{item.date}}</view>
            <view class="col-code">{{item.stockCode}}</view>
            <view class="col-name">{{item.stockName}}</view>
            <view class="col-type">
              <text class="type-badge" wx:if="{{item.type === 'buy'}}">ä¹°å…¥</text>
              <text class="type-badge" wx:else>å–å‡º</text>
            </view>
            <view class="col-price">Â¥{{item.price}}</view>
            <view class="col-qty">{{item.quantity}}</view>
          </view>
        </scroll-view>
      </view>

      <!-- é”™è¯¯ä¿¡æ¯ -->
      <view wx:if="{{previewData.errors.length > 0}}" class="error-section">
        <view class="error-header">é”™è¯¯ä¿¡æ¯ï¼š</view>
        <scroll-view class="error-list" scroll-y>
          <view class="error-item" wx:for="{{previewData.errors}}" wx:key="index">
            {{item}}
          </view>
        </scroll-view>
        <button 
          class="btn btn-ghost" 
          bindtap="exportErrorReport"
          size="mini"
        >
          å¯¼å‡ºé”™è¯¯æŠ¥å‘Š
        </button>
      </view>

      <!-- å¯¼å…¥æŒ‰é’® -->
      <view class="action-buttons">
        <button 
          class="btn btn-ghost" 
          bindtap="cancelImport"
          disabled="{{isProcessing}}"
        >
          å–æ¶ˆ
        </button>
        
        <button 
          class="btn btn-primary" 
          bindtap="executeImport"
          disabled="{{previewData.transactions.length === 0 || isProcessing}}"
          loading="{{isProcessing}}"
        >
          ç¡®è®¤å¯¼å…¥ ({{previewData.transactions.length}}æ¡)
        </button>
      </view>
    </view>
  </view>

  <!-- å¯¼å…¥ç»“æœ -->
  <view wx:if="{{importResult}}" class="card">
    <view class="card-header">å¯¼å…¥ç»“æœ</view>
    <view class="card-body">
      <view class="result-summary">
        <view class="result-item success">
          <text class="result-number">{{importResult.summary.saved}}</text>
          <text class="result-label">æˆåŠŸå¯¼å…¥</text>
        </view>
        <view class="result-item duplicate">
          <text class="result-number">{{importResult.summary.duplicates}}</text>
          <text class="result-label">é‡å¤è·³è¿‡</text>
        </view>
        <view class="result-item error">
          <text class="result-number">{{importResult.summary.errors}}</text>
          <text class="result-label">å¯¼å…¥å¤±è´¥</text>
        </view>
      </view>

      <view class="action-buttons">
        <button 
          class="btn btn-primary" 
          bindtap="reimport"
        >
          ç»§ç»­å¯¼å…¥
        </button>
        
        <button 
          class="btn btn-ghost" 
          bindtap="goBack"
        >
          è¿”å›åˆ—è¡¨
        </button>
      </view>
    </view>
  </view>
</view>